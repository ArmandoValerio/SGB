name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Install & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Validate index.html
        run: |
          if [ -f "index.html" ]; then
            echo "✓ index.html found"
            grep -q "<html" index.html && echo "✓ Has <html> tag"
            grep -q "<body" index.html && echo "✓ Has <body> tag"
            grep -q "<head" index.html && echo "✓ Has <head> tag"
            grep -q "Welcome to SGB" index.html && echo "✓ Content verified"
          else
            echo "✗ index.html not found"
            exit 1
          fi

      - name: Start server in background
        run: |
          node index.js > /tmp/server.log 2>&1 &
          echo $! > server.pid

      - name: Wait for server to start
        run: |
          for i in {1..15}; do
            if curl -sSf http://localhost:3000/; then
              echo "✓ Server ready"
              exit 0
            fi
            sleep 1
          done
          echo "✗ Server did not start" && cat /tmp/server.log && exit 1

      - name: Test index.html is served
        run: |
          curl -v http://localhost:3000/ | grep -q "Welcome to SGB" && echo "✓ index.html served correctly" || exit 1

      - name: Test API endpoint
        run: |
          curl -v http://localhost:3000/api/hello | grep -q "Hola" && echo "✓ API working" || exit 1

      - name: Stop server
        if: always()
        run: |
          kill "$(cat server.pid)" 2>/dev/null || true

  build:
    name: Build Docker image
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          load: true
          tags: sgb:latest

      - name: Upload Docker image as artifact
        run: |
          docker save sgb:latest -o /tmp/sgb.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/sgb.tar
